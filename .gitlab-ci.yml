# This file is a template, and might need editing before it works on your project.
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# This template uses one generic job with conditional builds
# for the default branch and all other (MR) branches.
include: '/deploy/version.yaml'
docker-build:
  # Use the official docker image.
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login $imageRepository -u "kalyan" -p "kalyan"
  #  - docker login $CI_FROG_REGISTRY -u "$CI_FROG_REGISTRY_USER" -p "$CI_FROG_REGISTRY_PASSWORD"
  # Default branch leaves tag empty (= latest tag) 
  # All other branches are tagged with the escaped branch name (commit ref slug)
  script:
    - |
      echo  "Info============"
      echo "development branch: $GIT_DEVELOPMENT_BRANCH"
      echo "Production branch: $GIT_PRODUCTION_BRANCH"

      if [[ "$imageAdminRelease" == true ]]; then
        tag=":$imageAdminAppVersion"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = ${tag}"
        docker build --pull -t "$imageAdminRepository${tag}" -f DockerAdmin .
        docker push "$imageAdminRepository${tag}"
      fi

      if [[ "$imagIndustryeRelease" == true ]]; then
        tag=":$imageIndustryAppVersion"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = ${tag}"
        docker build --pull -t "$imageIndustryRepository${tag}" -f DockerIndustry .
        docker push "$imageIndustryRepository${tag}"
      fi

      if [[ "$imageNiseRelease" == true ]]; then
        tag=":$imageNiseAppVersion"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = ${tag}"
        docker build --pull -t "$imageNiseRepository${tag}" -f DockerNise .
        docker push "$imageNiseRepository${tag}"
      fi

      if [[ "$imageSSPRelease" == true ]]; then
        tag=":$imageSSPAppVersion"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = ${tag}"
        docker build --pull -t "$imageSSPRepository${tag}" -f DockerSSP .
        docker push "$imageSSPRepository${tag}"
      fi

      if [[ "$imageYouthRelease" == true ]]; then
        tag=":$imageYouthAppVersion"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = ${tag}"
        docker build --pull -t "$imageYouthRepository${tag}" -f DockerSSP .
        docker push "$imageYouthRepository${tag}"
      fi
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /RELEASE\s*=/
      when: always

codestyle:
  stage: test
  dependencies: []
  script:
    - echo "Code quality check will be added later"
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /RELEASE\s*=/
      when: always

phpunit:
  stage: test
  dependencies:
    - docker-build
  script:
    - echo "unit test will be added later."
  when: manual
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /RELEASE\s*=/
      when: always

staging:
  stage: deploy
  dependencies:
    - docker-build
  script:
    #- curl https://cd.bus.softbd.xyz/api/webhook
    - echo "wait untill server go online"
  when: manual
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /RELEASE\s*=/
      when: always

production:
  stage: deploy
  script:
   - echo "production is not ready yet!"
  when: manual
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /RELEASE\s*=/
      when: always
